---
import { getCollection, CollectionEntry } from "astro:content";
import Layout from "../../layouts/Layout.astro";
import type { MarkdownHeading } from "astro";

export async function getStaticPaths() {
  const posts = await getCollection("posts");
  return posts.map((post) => ({
    params: { slug: post.slug },
    props: { post },
  }));
}

const { post } = Astro.props;
const { Content, headings } = await post.render();

// Process headings
const toc = headings.filter((heading: { depth: number }) => {
  // return heading.depth == 2;
  return true;
});

console.log(toc);
// TODO: Is using '-apple-system' safe on other systems?

function generateTableOfContents(headings2: any) {
  let html = "<ul>";

  for (const heading of headings2) {
    const { depth, slug, text } = heading;
    const listItem = `<li><a href="#${slug}">${text}</a></li>`;

    if (depth === 2) {
      html += listItem;
    } else if (depth === 3) {
      if (html.endsWith("</ul>")) {
        html = html.slice(-5); // Remove closing </ul> tag
      }
      html += "<ul>";
      html += listItem;
    }
  }

  html += "</ul>";
  return html;
}

// Example usage
const headings2 = [
  { depth: 2, slug: "overview", text: "Overview" },
  { depth: 2, slug: "parts", text: "Parts" },
  { depth: 3, slug: "printing-pcbs", text: "Printing PCBs" },
  { depth: 2, slug: "build-guide", text: "Build guide" },
  { depth: 3, slug: "pcb-assembly", text: "PCB assembly" },
  {
    depth: 3,
    slug: "setting-up-the-firmware",
    text: "Setting up the firmware",
  },
  {
    depth: 3,
    slug: "installing-stabilisers",
    text: "Installing stabilisers",
  },
  {
    depth: 3,
    slug: "mounting-the-plate-and-soldering-switches",
    text: "Mounting the plate and soldering switches",
  },
  { depth: 3, slug: "final-touches", text: "Final touches" },
];

const tableOfContents = generateTableOfContents(headings2);
console.log(tableOfContents);
---

<Layout
  title={post.title}
  class="flex justify-center py-20 mobile:mx-auto mobile:max-w-prose mobile:flex-col mobile:px-8 desktop:gap-8"
>
  <div class="basis-[21.5%] desktop:max-w-sm">
    <aside class="sticky top-8 desktop:pl-8">
      <section>
        <h1>{post.data.title}</h1>
        <p>
          {post.data.pubDate.toLocaleDateString("en-AU")}
        </p>
        {
          toc.length > 0 && (
            <details open class="group hidden desktop:block">
              <summary class="inline-block cursor-pointer after:inline-block after:pl-1 after:align-text-bottom after:font-['-apple-system'] after:transition-transform after:content-['►'] group-open:after:rotate-90">
                <h3 class="inline cursor-pointer">Contents</h3>
              </summary>
              <ul>
                {toc.map((heading: MarkdownHeading) => (
                  <li>
                    <a href={`#${heading.slug}`}>{heading.text}</a>
                  </li>
                ))}
              </ul>
            </details>
          )
        }
        <section class="my-4 hidden desktop:block">
          <a href="/">← Home</a>
        </section>
      </section>
    </aside>
  </div>
  <div class="max-w-prose basis-[57%]">
    <article class="">
      <Content />
      <section class="desktop:hidden">
        <a href="/">← Home</a>
      </section>
    </article>
  </div>
  <div class="max-w-sm basis-[21.5%]"></div>
</Layout>
